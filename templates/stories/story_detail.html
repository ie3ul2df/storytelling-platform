{% extends "base.html" %}
{% block content %}
{% load static %}

<div class="story-single-page-header p-2 rounded d-flex justify-content-between align-items-center bg-secondary">
    <h2 class="mt-2 text-muted fw-bold">{{ story.title }}</h2>
    {% with story.total_rank as rating %}
    <span class="ms-4 text-muted fw-bold">
        üèÜ
        {% for i in "12345"|make_list %}
        {% if forloop.counter <= rating %} ‚òÖ {% else %} ‚òÜ {% endif %} {% endfor %} ({{ rating|floatformat:"1" }}/5)
            </span>
            {% endwith %}
</div>

{% if story.image %}
<img src="{{ story.image.url }}" class="card-img-top" alt="{{ story.title }}" style="height: 200px; object-fit: cover;">
{% else %}
<img src="https://res.cloudinary.com/ddo1eszpe/image/upload/v1749497011/default-story-image_ttrfqb.webp"
    class="card-img-top" alt="Default story image" style="height: 200px; object-fit: cover;">
{% endif %}


<p><strong>By:</strong> {{ story.author.username }}</p>
<p>{{ story.description }}</p>
<hr>
<h3>Story Flow</h3>

{% for branch in branches %}
<div id="carousel-{{ branch.parent.id }}" class="carousel slide mb-4">

    {% include "stories/_carousel_controls.html" with parent=branch.parent sorted_chapters=branch.sorted_chapters %}

    <div class="carousel-inner">
        {% for chapter in branch.sorted_chapters %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="card {% if forloop.first %}border-primary shadow-sm{% endif %}">
                <div
                    class="card-header bg-light d-flex flex-column flex-sm-row justify-content-between align-items-center">
                    <span class="mb-2 mb-sm-0">
                        <strong>Chapter {{ forloop.counter }}</strong> ‚Äî {{ chapter.title }}
                        {% if chapter.id == branch.parent.id %}
                        <span class="badge bg-secondary ms-2">Original</span>
                        {% endif %}
                    </span>
                    <small class="avg ms-2 text-muted d-flex align-items-center gap-1">
                        <span class="avg-stars" data-average="{{ chapter.avg_rating }}"></span>
                        ({{ chapter.avg_rating|floatformat:1 }}/5) ‚Äî
                        {{ chapter.rating_count }} user{{ chapter.rating_count|pluralize }} rated
                    </small>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                    <div class="rating-stars mb-2" data-chapter="{{ chapter.id }}"
                        data-user-rating="{{ chapter.user_rating.value|default:'0' }}">
                        <strong>Rank this chapter:</strong>
                        <span class="stars">
                            {% for i in "12345"|make_list %}
                            <i class="star" data-value="{{ forloop.counter }}">&#9733;</i>
                            {% endfor %}
                        </span>
                    </div>
                    {% endif %}
                    {{ chapter.content|linebreaks }}
                    <p class="text-muted mb-0"><em>By {{ chapter.author.username }}</em></p>

                    {% if user == chapter.author %}
                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <a href="{% url 'chapter_edit' chapter.id %}" class="btn btn-sm btn-warning">‚úèÔ∏è Edit</a>
                        <a href="{% url 'chapter_delete' chapter.id %}" class="btn btn-sm btn-danger"
                            onclick="return confirm('Are you sure you want to delete this chapter?');">
                            üóëÔ∏è Delete
                        </a>

                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if user.is_authenticated %}
    {% with branch.sorted_chapters|first as season_root %}
    <div class="text-end mt-2">
        <a href="{% url 'chapter_create' story.id %}?parent={{ season_root.id }}" class="btn btn-outline-secondary">
            ‚ûï Create Your Chapter
        </a>
    </div>
    {% endwith %}
    {% endif %}

</div>
{% endfor %}

{% if story.allow_contributions or story.author.id == user.id %}
{% with branches|last as last_branch %}
{% with last_branch.sorted_chapters|last as last_chapter %}
<div class="text-end mt-4">
    <a href="{% url 'season_create' story.id %}" class="btn btn-outline-primary">
        ‚ûï Add New Season
    </a>
</div>
{% endwith %}
{% endwith %}
{% endif %}

<script src="{% static 'js/rating.js' %}"></script>
{% endblock %}