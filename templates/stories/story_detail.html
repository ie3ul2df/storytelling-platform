{% extends "base.html" %}
{% block content %}
{% load static %}
<h2>{{ story.title }}</h2>
<p><strong>By:</strong> {{ story.author.username }}</p>
<p>{{ story.description }}</p>
<hr>
<h3>Story Flow</h3>

{% for branch in branches %}
<div id="carousel-{{ branch.parent.id }}" class="carousel slide mb-4">

    {% include "stories/_carousel_controls.html" with parent=branch.parent sorted_chapters=branch.sorted_chapters %}

    <div class="carousel-inner">
        {% for chapter in branch.sorted_chapters %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="card {% if forloop.first %}border-primary shadow-sm{% endif %}">
                <div
                    class="card-header bg-light d-flex flex-column flex-sm-row justify-content-between align-items-center">
                    <span class="mb-2 mb-sm-0">
                        <strong>Chapter {{ forloop.counter }}</strong> — {{ chapter.title }}
                        {% if chapter.id == branch.parent.id %}
                        <span class="badge bg-secondary ms-2">Original</span>
                        {% endif %}
                    </span>
                    <small class="avg ms-2 text-muted d-flex align-items-center gap-1">
                        <span class="avg-stars" data-average="{{ chapter.avg_rating }}"></span>
                        ({{ chapter.avg_rating|floatformat:1 }}/5) —
                        {{ chapter.rating_count }} user{{ chapter.rating_count|pluralize }} rated
                    </small>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                    <div class="rating-stars mb-2" data-chapter="{{ chapter.id }}"
                        data-user-rating="{{ chapter.user_rating.value|default:'0' }}">
                        <strong>Rank this chapter:</strong>
                        <span class="stars">
                            {% for i in "12345"|make_list %}
                            <i class="star" data-value="{{ forloop.counter }}">&#9733;</i>
                            {% endfor %}
                        </span>
                    </div>
                    {% endif %}
                    {{ chapter.content|linebreaks }}
                    <p class="text-muted mb-0"><em>By {{ chapter.author.username }}</em></p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if story.allow_contributions or story.author == user %}
    <div class="text-end mb-4">
        <a href="{% url 'chapter_create' story.id %}?parent={{ branch.parent.id }}" class="btn btn-outline-primary">
            ➕ Add your chapter to this story
        </a>
    </div>
    {% endif %}
</div>
{% endfor %}

<script src="{% static 'js/rating.js' %}"></script>
{% endblock %}