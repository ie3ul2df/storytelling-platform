{% extends "base.html" %}
{% block content %}
{% load static %}

<div class="p-2 rounded d-flex justify-content-between align-items-center bg-secondary">
    <h2 class="mt-2 text-muted fw-bold">{{ story.title }}</h2>
    {% with story.total_rank as rating %}
    <span class="ms-4 text-muted fw-bold"> üèÜ
        {% for i in "12345"|make_list %}
        {% if forloop.counter <= rating %} ‚òÖ {% else %} ‚òÜ {% endif %} {% endfor %} ({{ rating|floatformat:"1" }}/5)
            </span>
            {% endwith %}
</div>

<p><strong>By:</strong> {{ story.author.username }}</p>
<p>{{ story.description }}</p>

<hr>
<h3>Story Flow</h3>

{% for branch in branches %}
<div id="carousel-{{ branch.parent.id }}" class="carousel slide mb-4">

    {% include "stories/_carousel_controls.html" with parent=branch.parent sorted_chapters=branch.sorted_chapters %}

    <div class="carousel-inner">
        {% for chapter in branch.sorted_chapters %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="card {% if forloop.first %}border-primary shadow-sm{% endif %}">
                <div
                    class="card-header bg-light d-flex flex-column flex-sm-row justify-content-between align-items-center">
                    <span class="mb-2 mb-sm-0">
                        <strong>Chapter {{ forloop.counter }}</strong> ‚Äî {{ chapter.title }}
                        {% if chapter.id == branch.parent.id %}
                        <span class="badge bg-secondary ms-2">Original</span>
                        {% endif %}
                    </span>
                    <small class="avg ms-2 text-muted d-flex align-items-center gap-1">
                        <span class="avg-stars" data-average="{{ chapter.avg_rating }}"></span>
                        ({{ chapter.avg_rating|floatformat:1 }}/5) ‚Äî
                        {{ chapter.rating_count }} user{{ chapter.rating_count|pluralize }} rated
                    </small>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                    <div class="rating-stars mb-2" data-chapter="{{ chapter.id }}"
                        data-user-rating="{{ chapter.user_rating.value|default:'0' }}">
                        <strong>Rank this chapter:</strong>
                        <span class="stars">
                            {% for i in "12345"|make_list %}
                            <i class="star" data-value="{{ forloop.counter }}">&#9733;</i>
                            {% endfor %}
                        </span>
                    </div>
                    {% endif %}
                    {{ chapter.content|linebreaks }}
                    <p class="text-muted mb-0"><em>By {{ chapter.author.username }}</em></p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if story.allow_contributions or story.author == user %}
    <div class="text-end mt-3 d-flex flex-column align-items-end gap-2">

        {% with branch.sorted_chapters|first as root_chapter %}
        <a href="{% url 'chapter_create' story.id %}?parent={{ root_chapter.id }}" class="btn btn-outline-secondary">
            + Create your Chapter 2
        </a>
        {% endwith %}

    </div>
    {% endif %}

</div>
{% endfor %}
{% with branch.sorted_chapters|last as last_chapter %}
<a href="{% url 'chapter_create' story.id %}?parent={{ last_chapter.id }}" class="btn btn-outline-primary">
    ‚ûï Create New Chapter
</a>
{% endwith %}
<script src="{% static 'js/rating.js' %}"></script>
{% endblock %}